# PgBouncer configuration for ITS Camera AI high-throughput operations
# Optimized for 3000+ frame inserts/sec and sub-10ms query response times

[databases]
# Production database configuration
its_camera_ai_prod = host=localhost port=5432 dbname=its_camera_ai_prod user=its_camera_ai_user
its_camera_ai_prod_ro = host=localhost port=5432 dbname=its_camera_ai_prod user=its_camera_ai_readonly

# Staging environment
its_camera_ai_staging = host=localhost port=5432 dbname=its_camera_ai_staging user=its_camera_ai_user

# Development environment  
its_camera_ai_dev = host=localhost port=5432 dbname=its_camera_ai_dev user=its_camera_ai_user

# Separate pool for high-throughput frame ingestion
its_camera_ai_ingest = host=localhost port=5432 dbname=its_camera_ai_prod user=its_camera_ai_ingest pool_size=50 reserve_pool=10

[pgbouncer]
# Connection settings optimized for high throughput
listen_port = 6432
listen_addr = 0.0.0.0
auth_type = md5
auth_file = /etc/pgbouncer/userlist.txt

# Pool configuration for different workloads
pool_mode = transaction
max_client_conn = 1000
default_pool_size = 25
min_pool_size = 5
reserve_pool_size = 5
reserve_pool_timeout = 5

# High-performance settings
max_db_connections = 100
max_user_connections = 100

# Connection timeouts optimized for real-time operations
server_reset_query = DISCARD ALL
server_check_delay = 30
server_check_query = SELECT 1
server_lifetime = 3600
server_idle_timeout = 600

# Client connection settings
client_idle_timeout = 0
client_login_timeout = 60

# Query timeouts
query_timeout = 0
query_wait_timeout = 120
cancel_wait_timeout = 10

# DNS and socket settings
dns_max_ttl = 15
dns_zone_check_period = 0
resolv_conf = /etc/resolv.conf

# Logging configuration
log_connections = 1
log_disconnections = 1
log_pooler_errors = 1
log_stats = 1
stats_period = 60

# Application name for monitoring
application_name_add_host = 1

# TLS/SSL configuration (production)
;server_tls_sslmode = require
;server_tls_ca_file = /etc/ssl/certs/ca-certificates.crt
;server_tls_key_file = /etc/pgbouncer/server.key
;server_tls_cert_file = /etc/pgbouncer/server.crt

# Performance tuning
tcp_defer_accept = 1
tcp_keepalive = 1
tcp_keepcnt = 3
tcp_keepidle = 600
tcp_keepintvl = 30

# Memory settings
pkt_buf = 4096
listen_backlog = 128
sbuf_loopcnt = 5

# Administrative settings
admin_users = its_admin
stats_users = its_monitor, its_admin

# Log file configuration  
logfile = /var/log/pgbouncer/pgbouncer.log
pidfile = /var/run/pgbouncer/pgbouncer.pid

# Ignore startup parameters that might be sent by applications
ignore_startup_parameters = extra_float_digits

# Disable server-side prepared statements for transaction pooling
server_reset_query_always = 0

# Additional optimizations for high-throughput scenarios
max_packet_size = 2147483647
disable_pqexec = 0

# Override settings for specific databases
;its_camera_ai_ingest.pool_mode = session
;its_camera_ai_ingest.max_db_connections = 50