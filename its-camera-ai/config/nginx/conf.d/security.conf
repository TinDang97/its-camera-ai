# Security Configuration for ITS Camera AI
# Additional security headers and configurations

# Hide nginx version
server_tokens off;

# Prevent clickjacking
add_header X-Frame-Options "SAMEORIGIN" always;

# Prevent MIME type sniffing
add_header X-Content-Type-Options "nosniff" always;

# Enable XSS protection
add_header X-XSS-Protection "1; mode=block" always;

# Control referrer information
add_header Referrer-Policy "strict-origin-when-cross-origin" always;

# Permissions Policy (formerly Feature Policy)
add_header Permissions-Policy "camera=(), microphone=(), geolocation=(), payment=(), usb=(), magnetometer=(), gyroscope=(), accelerometer=()" always;

# Strict Transport Security (HTTPS only)
add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;

# Content Security Policy
set $csp "default-src 'self'; ";
set $csp "${csp}script-src 'self' 'unsafe-inline' 'unsafe-eval' https://apis.google.com https://www.google-analytics.com; ";
set $csp "${csp}style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; ";
set $csp "${csp}img-src 'self' data: blob: https: http:; ";
set $csp "${csp}font-src 'self' data: https://fonts.gstatic.com; ";
set $csp "${csp}connect-src 'self' ws: wss: https: http:; ";
set $csp "${csp}media-src 'self' blob: data:; ";
set $csp "${csp}frame-src 'self' https:; ";
set $csp "${csp}object-src 'none'; ";
set $csp "${csp}base-uri 'self'; ";
set $csp "${csp}form-action 'self'; ";
set $csp "${csp}frame-ancestors 'self'; ";
set $csp "${csp}upgrade-insecure-requests;";

add_header Content-Security-Policy $csp always;

# Block access to hidden files and directories
location ~ /\. {
    deny all;
    return 404;
}

# Block access to backup files
location ~ \.(backup|bak|old|tmp|orig|~)$ {
    deny all;
    return 404;
}

# Block access to version control directories
location ~ /\.(git|svn|hg|bzr) {
    deny all;
    return 404;
}

# Block access to configuration files
location ~ \.(conf|config|yml|yaml|ini|env)$ {
    deny all;
    return 404;
}

# Block access to log files
location ~ \.(log|logs)$ {
    deny all;
    return 404;
}