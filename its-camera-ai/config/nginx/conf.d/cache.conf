# Caching Configuration for ITS Camera AI
# Optimized caching rules for different asset types

# Cache zones
proxy_cache_path /var/cache/nginx/static levels=1:2 keys_zone=static_cache:10m max_size=1g inactive=60m use_temp_path=off;
proxy_cache_path /var/cache/nginx/api levels=1:2 keys_zone=api_cache:10m max_size=100m inactive=10m use_temp_path=off;

# Cache static assets
location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|webp|avif)$ {
    expires 1y;
    add_header Cache-Control "public, immutable";
    add_header Vary "Accept-Encoding";

    # Enable proxy cache
    proxy_cache static_cache;
    proxy_cache_valid 200 1y;
    proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;
    proxy_cache_lock on;
    proxy_cache_revalidate on;

    # Cache headers
    proxy_set_header Cache-Control "public, max-age=31536000";
}

# Cache fonts
location ~* \.(woff|woff2|ttf|eot|otf)$ {
    expires 1y;
    add_header Cache-Control "public, immutable";
    add_header Access-Control-Allow-Origin "*";

    proxy_cache static_cache;
    proxy_cache_valid 200 1y;
}

# Cache API responses (selective)
location ~ ^/api/(config|health|version)$ {
    proxy_cache api_cache;
    proxy_cache_valid 200 5m;
    proxy_cache_use_stale error timeout updating;
    proxy_cache_lock on;

    add_header X-Cache-Status $upstream_cache_status;
}

# No cache for dynamic content
location ~ ^/api/(auth|user|session|stream|websocket) {
    add_header Cache-Control "no-cache, no-store, must-revalidate";
    add_header Pragma "no-cache";
    add_header Expires "0";
}

# HTML files - short cache with revalidation
location ~* \.(html|htm)$ {
    expires 10m;
    add_header Cache-Control "public, must-revalidate";

    proxy_cache_bypass $http_pragma $http_authorization;
    proxy_no_cache $http_pragma $http_authorization;
}

# Service worker - no cache
location = /sw.js {
    expires -1;
    add_header Cache-Control "no-cache, no-store, must-revalidate";
    add_header Pragma "no-cache";
}

# Web app manifest
location = /manifest.json {
    expires 1d;
    add_header Cache-Control "public, max-age=86400";
}